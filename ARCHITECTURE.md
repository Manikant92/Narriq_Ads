# Narriq Architecture

## System Overview

```
┌────────────────────────────────────────────────────────────────────────┐
│                              USER                                       │
│                         (Web Browser)                                   │
└─────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         FRONTEND (React)                                │
│                         localhost:5173                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  Generate   │  │  Project    │  │  Timeline   │  │  Sketch     │   │
│  │  Ad Modal   │  │  Gallery    │  │  Editor     │  │  Canvas     │   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │
└─────────┼────────────────┼────────────────┼────────────────┼──────────┘
          │                │                │                │
          └────────────────┴────────────────┴────────────────┘
                                  │
                                  │ HTTP (Vite Proxy)
                                  ▼
┌────────────────────────────────────────────────────────────────────────┐
│                      MOTIA BACKEND                                      │
│                      localhost:3000                                     │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        API LAYER                                  │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐            │  │
│  │  │/generate │ │/project  │ │/render   │ │/sketch   │            │  │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘            │  │
│  └───────┼────────────┼────────────┼────────────┼───────────────────┘  │
│          │            │            │            │                       │
│          ▼            ▼            ▼            ▼                       │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    EVENT BUS (BullMQ)                             │  │
│  │                                                                    │  │
│  │   ad.generation.started ──▶ site.scraped ──▶ brand.extracted     │  │
│  │          │                                         │              │  │
│  │          ▼                                         ▼              │  │
│  │   scripts.generated ──▶ moderation.passed ──▶ images.generated   │  │
│  │          │                                         │              │  │
│  │          ▼                                         ▼              │  │
│  │   analytics.scored ──▶ tts.completed ──▶ ad.generation.completed │  │
│  │                                                                    │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                  │                                      │
│                                  ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    EVENT HANDLERS                                 │  │
│  │                                                                    │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │  │
│  │  │ scrape     │  │ brand      │  │ script     │  │ content    │  │  │
│  │  │ site       │  │ extract    │  │ gen        │  │ moderation │  │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │  │
│  │                                                                    │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │  │
│  │  │ image      │  │ analytics  │  │ tts        │  │ enqueue    │  │  │
│  │  │ gen        │  │ agent      │  │            │  │ renders    │  │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │  │
│  │                                                                    │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                  │                                      │
│                                  ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    MOTIA PLUGINS                                  │  │
│  │                                                                    │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │  │
│  │  │ States     │  │ Logs       │  │ Endpoint   │  │Observability│  │  │
│  │  │ (Redis)    │  │            │  │            │  │            │  │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │  │
│  │                                                                    │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    CRON JOBS                                      │  │
│  │  ┌────────────────────────────────────────────────────────────┐  │  │
│  │  │ cleanup-cron (hourly) - Remove old projects                 │  │  │
│  │  └────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────────┐
│                      EXTERNAL SERVICES                                  │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │    OpenAI       │  │    OpenAI       │  │    OpenAI       │        │
│  │    GPT-4        │  │    DALL-E 3     │  │    TTS          │        │
│  │                 │  │                 │  │                 │        │
│  │  • Brand Extract│  │  • Scene Images │  │  • Voiceovers   │        │
│  │  • Script Gen   │  │                 │  │                 │        │
│  │  • Analytics    │  │                 │  │                 │        │
│  │  • Moderation   │  │                 │  │                 │        │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
1. User enters URL
        │
        ▼
2. POST /api/generate
        │
        ▼
3. Emit: ad.generation.started
        │
        ▼
4. scrape-site → Cheerio scrapes HTML
        │
        ▼
5. Emit: site.scraped
        │
        ▼
6. brand-extract → GPT-4 analyzes brand
        │
        ▼
7. Emit: brand.extracted
        │
        ▼
8. script-gen → GPT-4 writes scripts
        │
        ▼
9. Emit: scripts.generated
        │
        ▼
10. content-moderation → OpenAI Moderation API
        │
        ▼
11. Emit: moderation.passed
        │
        ▼
12. image-gen → DALL-E 3 generates images
        │
        ▼
13. Emit: images.generated
        │
        ▼
14. analytics-agent → GPT-4 predicts performance
        │
        ▼
15. Emit: analytics.scored
        │
        ▼
16. tts → OpenAI TTS generates audio
        │
        ▼
17. Emit: tts.completed
        │
        ▼
18. enqueue-renders → Save to state
        │
        ▼
19. Emit: ad.generation.completed
        │
        ▼
20. Frontend polls GET /api/project/:id
        │
        ▼
21. User sees generated ads!
```

## State Storage

```
┌─────────────────────────────────────────────────────────────┐
│                    MOTIA STATE (Redis)                       │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  projects   │  │  analytics  │  │   audio     │         │
│  │             │  │             │  │             │         │
│  │ projectId   │  │ projectId   │  │ audioKey    │         │
│  │ brandProfile│  │ results[]   │  │ data(base64)│         │
│  │ variants[]  │  │ analyzedAt  │  │ createdAt   │         │
│  │ status      │  │             │  │             │         │
│  │ createdAt   │  │             │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                              │
│  ┌─────────────┐                                            │
│  │ renderJobs  │                                            │
│  │             │                                            │
│  │ jobId       │                                            │
│  │ projectId   │                                            │
│  │ variantId   │                                            │
│  │ status      │                                            │
│  │ progress    │                                            │
│  │ createdAt   │                                            │
│  └─────────────┘                                            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Motia Workbench View

The Motia Workbench at http://localhost:3000 shows:

```
┌─────────────────────────────────────────────────────────────────────┐
│  Motia Workbench                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Flow: ad-generation                                                 │
│                                                                      │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐      │
│  │generate  │───▶│ scrape   │───▶│ brand    │───▶│ script   │      │
│  │ad-api    │    │ site     │    │ extract  │    │ gen      │      │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘      │
│                                                       │              │
│                                                       ▼              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐      │
│  │ enqueue  │◀───│   tts    │◀───│analytics │◀───│ image    │      │
│  │ renders  │    │          │    │ agent    │    │ gen      │      │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘      │
│       │                                               ▲              │
│       │                                               │              │
│       │              ┌──────────┐                     │              │
│       │              │ content  │─────────────────────┘              │
│       │              │moderation│                                    │
│       │              └──────────┘                                    │
│       ▼                                                              │
│  ┌──────────┐                                                        │
│  │ workflow │                                                        │
│  │   end    │                                                        │
│  └──────────┘                                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```
